<html>
    <head>
        <title>Settings</title>
        <link rel="stylesheet" type="text/css" href="settings.css">
        <link rel="stylesheet" href="/css/bootstrap.min.css">
        <script src="/js/bootstrap.min.js"></script>
        <script src="/heic2any.min.js"></script>
    </head>

    <body onload="FetchSettings()">

        <img class="back-arrow" src="arrow-left.svg" alt="back-arrow" onclick={location.replace('/dashboard')}>
        
        <div class="profile">
            <h2>SETTINGS</h2> 
            <div class="loader" id="profile-loader"></div>
            <img class="avatar" alt="avatar" id="avatar" onclick="openEditPhotoForm()">
            <div class="edit-name-div">
                <p id="first_name" class="first_name"></p>
                <p id="last_name" class="last_name"></p>
            </div>
        </div>


        <!-- GENERIC POP-UP -->
        <div class="settings-popup" id="settings-popup">
            <img class="close-popup-form-x" src="x.svg" onclick={closePopup()}>
            <div id="popup-view"></div>
        </div>

        <div class="button-layer">
            <Button type="button" onclick="editAccountPopup()"> ACCOUNT </Button>

            <Button type="button"id="services-button" onclick="openEditServices()">SERVICES </Button>

            <Button type="button" onclick="editHistory()"> HISTORY </Button>
        </div>

        <div class="button-layer">
            <Button type="button" onclick="editActivity()"> ACTIVITY </Button>
            
            <Button type="button" onclick="editRules()"> RULES </Button>

            <Button type="button" onclick="editContactUs()"> CONTACT US </Button>
        </div>
    
        <script>
            async function FetchSettings(){

                document.getElementById("profile-loader").style.display = "-webkit-inline-box"

                const market_token = getMarketToken()
                const URL = "http://localhost:8000/profile"
                const headers = {"Content-Type" : "application/json; charset=utf-8"}
                const body = JSON.stringify({token: market_token})

                try{

                    const res = await fetch(URL,{
                        method: "POST",
                        mode: "cors",
                        headers: headers,
                        body: body
                    })

                    const res_body = await res.json()
                    const data = await res_body.profile

                    if(!data) throw Error
                    
                    document.getElementById("profile-loader").style.display = "none"
                    document.querySelector("#first_name").insertAdjacentHTML("afterbegin", data.first_name)
                    document.querySelector("#last_name").insertAdjacentHTML("afterbegin", data.last_name)
                    document.getElementById("avatar").src = "data:image/png;base64," + data.avatar
                    document.getElementById("avatar").style.display = "block"

                }catch (error) {
                    console.log(error)
                    location.replace('/')
                }
                
            }

            async function updateAvatarPhoto(){
                avatar = document.getElementById('new-img')
                cookies = document.cookie.split(';')

                const market_token = getMarketToken()

                const URL = "http://localhost:8000/settings/avatar"
                const headers = {"Content-Type" : "application/json; charset=utf-8"}
                const body = JSON.stringify({
                    token : market_token,
                    avatar : avatar.src
                })

                // make post
                const res = await fetch('http://localhost:8000/settings/avatar', {
                    method: "POST",
                    mode: "cors",
                    headers: headers,
                    body: body
                })

                const data = await req.json()  

                //** STILL IN PROGRESS */
                data ? location.replace("/settings") : location.replace("/")
            }
        
            // view the history settings
            function editHistory(){
                console.log("Changing History")
            }

            // view activity settings 
            function editActivity(){
                console.log("Changing Activity")
            }

            // view account settings
            function editAccount(){
                console.log("Changing Account")
            }

            // view rules settings
            function editRules(){
                console.log("Viewing Rules")
            }
            
            // send a contact us 
            function editContactUs(){
                console.log("Sending a Contact Us")
            }
     
            function editAccountPopup(){
                document.getElementById("settings-popup").style.display = "block"

                const first_name = document.querySelector("#first_name").innerHTML
                const last_name = document.querySelector("#last_name").innerHTML

                const avatar = document.querySelector("#avatar")

                document.getElementById("popup-view").innerHTML = `
                <div class="form-container">
                    <h2>Edit Account</h2>

                    <h4>Edit Avatar</h4>
                    
                    <div class="uploaded-image" id="uploaded-image">
                        <div class="loader" id="avatar-loader"></div>
                        <img src=${avatar.src} alt="" id="new-img" class="new-img">
                    </div>
                    Select Image: 
                    
                    <input type="file" id="edit-photo-img" name="img" accept="image/*" required>
                    
                    <h4>Edit Name </h4>
                    
                    First Name:

                    <input type="text" id="edited-first-name" value="${first_name}" required>

                    Last Name:

                    <input type="text" id="edited-last-name" value="${last_name}" required>

                    <Button type="submit" id="name-edit-btn" class="name-edit-btn" onClick="handleAccountChange()"> Make Change </Button>
                </div>`

                const new_img = document.querySelector("#new-img")
                const avatar_input = document.querySelector("#edit-photo-img")

                avatar_input.addEventListener( "change", () => {displayNewAvatar(avatar_input, new_img)})
            }

            const displayNewAvatar = async (avatar_input, new_img) => {

                let file = avatar_input.files[0]

                const reader = new FileReader()

                new_img.style.display="none"
                document.getElementById("avatar-loader").style.display = "-webkit-inline-box"

                try {
                    if(file['type'] == "image/heic"){
                        const URL = await window.URL.createObjectURL(file)
                        
                        const res = await fetch(URL)

                        const blob = await res.blob()

                        const png = await heic2any({blob, toType: "image/png", multiple: "true",})

                        file = png[0]
                    }
                    reader.readAsDataURL(file)

                    reader.onload = () => {
                        new_img.src = reader.result
                    }
                } catch(error) {
                    console.log(error)
                }

                document.getElementById("avatar-loader").style.display = "none"
                new_img.style.display="revert"
            }

            // make changes to users name
            const handleAccountChange = async () => {

                const first_name = document.getElementById("edited-first-name").value
                const last_name = document.getElementById("edited-last-name").value
                const avatar = document.getElementById('new-img')

                const market_token = getMarketToken()

                const URL = "http://localhost:8000/settings/account"
                const body = JSON.stringify({ token: market_token, first_name : first_name, last_name : last_name , avatar: avatar.src})
                const headers = {"Content-Type" : "application/json; charset=utf-8"}

                try {
                    const req = await fetch(URL, {
                        method: "POST",
                        mode: "cors",
                        headers: headers,
                        body: body
                    })

                    const res = await req.json()

                    res ? location.replace("/settings") : location.replace("/")

                } catch(error) {
                    console.log(error)
                }
            }

            function closePopup(){
                document.getElementById("settings-popup").style.display = "none"
            }

            // function used for going back to dashboard
            function goBack(){
                location.replace("/dashboard")
            }

            // *  HELPERS */
            const getMarketToken = () => {
                cookies = document.cookie.split(';')
                market_token = null

                // retreive market_cookie from cookies
                for(i = 0; i < cookies.length; i++){
                    if(cookies[i].includes('market_token=')){
                        return market_token = cookies[i].split('market_token=')[1]
                    }
                }
                return market_token
            }
        </script>
    </body>
</html>
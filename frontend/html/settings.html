<html>
    <head>
        <link rel="stylesheet" type="text/css" href="settings.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <script src="/heic2any.min.js"></script>
        <title>Settings</title>

    </head>

    <body onload="fethProfileData()">

        <div class="back-button">
            <button type="button" class="btn btn-secondary" style="width: 100px;height: 75; background-color: grey;border: none;" onclick="goBack()">
                <img class="back-arrow" src="arrow-left.svg" alt="back-arrow">
            </button>
        </div>
        

        <div class="profile">
            <!-- user avatar -->
            <div class="avatar-div">
                Settings
                <img class="avatar" alt="avatar" id="avatar" onclick="openEditPhotoForm()">
                <div class="edit-name-div" onclick="editName()">
                    <p id="first_name" class="first_name"></p>
                    <p id="last_name" class="last_name"></p>
                </div>
            </div>
        </div>

        <!-- pop up for changing picture -->
        <div class="edit-photo-popup">
            <div class="form-popup" id="popup-form">
              <!-- <div class="form-container"> -->
            <form class="form-container" action="javascript:updateAvatarPhoto()">
                <img class="close-popup-form-x" src="x.svg" alt="close-popup-form-x" onclick="closeEditPhotoForm()">
                <br>
                <h2>Change Photo</h2>
                <div class="uploaded-image" id="uploaded-image">
                    <div class="loader" id="loader"></div>
                    <img src="" alt="" id="new-img" class="new-img">
                </div>
                Select Image: 
                <br>
                <input type="file" id="edit-photo-img" name="img" accept="image/*" required>
                <br><br>
                Password: 
                <br>
                <input type="password" id="edit-photo-psw" placeholder="Your Password" name="psw" required>
                <br><br>
                <button type="submit" id="photo-edit-btn" class="photo-edit-btn" style="background-color: dodgerblue;color:white">Make Change</button>
              </div>
            </form>
          </div>

        <div class="div-buttons">
            <div class="div-buttons-layer-one">

                <div class="bootstrap-button-div">
                    <button type="button" class="btn btn-primary" onclick="editServices()">
                        Services
                    </button>
                </div>

                <div class="bootstrap-button-div">
                    <button type="button" class="btn btn-primary" onclick="editHistory()">
                        History
                    </button>
                </div>

                <div class="bootstrap-button-div">
                    <button type="button" class="btn btn-primary" onclick="editActivity()">
                        Activity
                    </button>
                </div>

            </div>

            <div class="div-buttons-layer-two">

                <div class="bootstrap-button-div">
                    <button type="button" class="btn btn-primary" onclick="editAccount()">
                        Account
                    </button>
                </div>

                <div class="bootstrap-button-div">
                    <button type="button" class="btn btn-primary" onclick="editRules()">
                        Rules
                    </button>
                </div>

                <div class="bootstrap-button-div">
                    <button type="button" class="btn btn-primary" onclick="editContactUs()">
                        Contact Us
                    </button>
                </div>

            </div>
        </div>

        <!-- footer -->
        <footer class="profile-footer">
            <div class="loader"></div>

        </footer>

        <script>

            /* initial fetch for all user data */
            function fethProfileData(){

                // get the users cookies
                cookies = document.cookie.split(';')
                market_token = ''

                // retreive market_cookie from cookies
                for(i = 0; i < cookies.length; i++){
                    if(cookies[i].includes('market_token=')){
                        market_token = cookies[i].split('market_token=')[1]
                    }
                }

                fetch("http://127.0.0.1:5000/profile",
                    {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type" : "application/json; charset=utf-8"
                        },
                        body: JSON.stringify({
                            token: market_token
                        })
                    }
                ).then(response => response.json())
                .then(data => {
                    // entire dataset
                    profile_data = data.profile

                    document.querySelector("#first_name").insertAdjacentHTML("afterbegin", profile_data.first_name)
                    document.querySelector("#last_name").insertAdjacentHTML("afterbegin", profile_data.last_name)
                    document.getElementById("avatar").src = "data:image/png;base64," + profile_data.avatar
                })
                
            }

            /* avatar photo edit section */
            function openEditPhotoForm(){
                document.getElementById("popup-form").style.display = "block";
            }
            function closeEditPhotoForm() {
                document.getElementById("popup-form").style.display = "none";
            }
            const img = document.querySelector("#new-img")
            const uploadAvatarButton = document.querySelector("#edit-photo-img")
            uploadAvatarButton.addEventListener("change", function(){

                // this is no intially reset back to none then both the previous file will and loader will display
                img.style.display = "none"
                document.getElementById("loader").style.display = "-webkit-inline-box"

                const file = this.files[0]
                if(file['type'] == "image/heic"){
                    const objectURL = window.URL.createObjectURL(file)

                    new_file = fetch(objectURL)
                        .then((res) => res.blob())
                        .then((blob) =>
                            heic2any({
                                blob,
                                toType: "image/png",
                                multiple: true,
                            })
                        )
                        .then((conversionResult) => {
                            image = conversionResult[0]
                            var url = URL.createObjectURL(image);
                            img.src = url;
                            document.getElementById("loader").style.display = "none"
                            img.style.display="revert"
                        })
                        .catch((e) => {
                            // see error handling section
                            console.log(e)
                        });
                        
                }else if(file){
                    const reader = new FileReader()
                    reader.onload = function(){
                        const result = reader.result
                        img.src = result
                        document.getElementById("loader").style.display = "none"
                        img.style.display="revert"
                    }
                    reader.readAsDataURL(file)
                }
            })


            function updateAvatarPhoto(){

                // upload the the new photo to database
                console.log("working on getting photo uploaded")

                avatar = document.getElementById('new-img')
                console.log(avatar.height)
                console.log(avatar.width)


                // convert the blob type to image
                var canvas = document.createElement('canvas')
                canvas.width  = 220;
                canvas.height = 220;
                var ctx = canvas.getContext("2d")
                ctx.imageSmoothingEnabled = true
                var img = document.getElementById('new-img')
                ctx.drawImage(img,0,0, 220,220)

                var jpegFile = canvas.toDataURL('image/png')
                avatar.src = jpegFile
                console.log(jpegFile)

                // get the users cookies
                cookies = document.cookie.split(';')
                market_token = ''

                // retreive market_cookie from cookies
                for(i = 0; i < cookies.length; i++){
                    if(cookies[i].includes('market_token=')){
                        market_token = cookies[i].split('market_token=')[1]
                    }
                }
                
                // make post
                fetch('http://127.0.0.1:5000/settings/avatar', 
                    {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type" : "application/json; charset=utf-8"
                        },
                        body: JSON.stringify({
                            token: market_token,
                            avatar: jpegFile
                        })
                    })
                    .then(result => result.json())
                    .then(data =>{
                        console.log(data)
                    })

            }
            

            // make changes in the users name
            function editName(){
                console.log("Changing Name")
            }

            // view the services settings
            function editServices(){
                console.log("Changing Services")
            }

            // view the history settings
            function editHistory(){
                console.log("Changing History")
            }

            // view activity settings 
            function editActivity(){
                console.log("Changing Activity")
            }

            // view account settings
            function editAccount(){
                console.log("Changing Account")
            }

            // view rules settings
            function editRules(){
                console.log("Viewing Rules")
            }
            
            // send a contact us 
            function editContactUs(){
                console.log("Sending a Contact Us")
            }
            // function used for going back to dashboard
            function goBack(){
                location.replace("/dashboard")
            }
        </script>
    </body>
</html>
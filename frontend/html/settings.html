<html>
    <head>
        <title>Settings</title>
        <link rel="stylesheet" type="text/css" href="settings.css">
        <link rel="stylesheet" href="/css/bootstrap.min.css">
        <script src="/js/bootstrap.min.js"></script>
        <script src="/heic2any.min.js"></script>
    </head>

    <body onload="FetchSettings()">

        <img class="back-arrow" src="arrow-left.svg" alt="back-arrow" onclick={location.replace('/dashboard')}>
        
        <div class="profile">
            Settings 
            <div class="loader" id="profile-loader"></div>
            <img class="avatar" alt="avatar" id="avatar" onclick="openEditPhotoForm()">
            <div class="edit-name-div">
                <p id="first_name" class="first_name"></p>
                <p id="last_name" class="last_name"></p>
            </div>
        </div>

        <!-- pop up for changing picture -->
        <div class="edit-photo-popup">
            <div class="form-popup" id="popup-form">
              <!-- <div class="form-container"> -->
            <form class="form-container" action="javascript:updateAvatarPhoto()">
                <img class="close-popup-form-x" src="x.svg" alt="close-popup-form-x" onclick="closeEditPhotoForm()">
                <br>
                <h2>Change Photo</h2>
                <br>
                <div class="uploaded-image" id="uploaded-image">
                    <div class="loader" id="avatar-loader"></div>
                    <img src="" alt="" id="new-img" class="new-img">
                </div>
                Select Image: 
                <br>
                <input type="file" id="edit-photo-img" name="img" accept="image/*" required>
                <br><br>
                <button type="submit" id="photo-edit-btn" class="photo-edit-btn" style="background-color: dodgerblue;color:white">Make Change</button>
              </div>
            </form>
        </div>

        <!-- pop up for services -->
        <div class="edit-services-popup">
            <div class="form-popup" id="service-popup-form">
                <form class="form-container" action="javascript:editServices()">
                    <img class="close-popup-form-x" src="x.svg" alt="close-popup-form-x" onclick="closeEditServices()">
                    <h2>Services</h2>
                    <!-- loader for while user services are being fetched -->
                    <div class="loader" id="service-loader-fetch"></div>
                    <br>
                    <!-- service list -->
                    <div class=bootstrap-list>
                        <div class="list-group">
                            <div id="services-list">
                                <!-- insert the services list -->
                            </div>
                        </div>
                    </div>
                    <br>
                    <button type="submit" id="service-edit-btn" class="service-edit-btn" style="background-color: dodgerblue;color:white;width: 60%;margin-left: 20%; margin-right: 20%">+ Add</button>
                </form>
            </div>
        </div>

        <!-- HANDLE ALL SETTINGS ADJUSTMENTS -->
        <div class="popup-setting">

        </div>

        <!-- GENERIC POP-UP -->
        <div class="settings-popup" id="settings-popup">
            <img class="close-popup-form-x" src="x.svg" onclick={closePopup()}>
            <div id="popup-view"></div>
        </div>

        <div class="button-layer">
            <Button type="button" onclick="editAccountPopup()"> ACCOUNT </Button>

            <Button type="button"id="services-button" onclick="openEditServices()">SERVICES </Button>

            <Button type="button" onclick="editHistory()"> HISTORY </Button>
        </div>

        <div class="button-layer">
            <Button type="button" onclick="editActivity()"> ACTIVITY </Button>
            
            <Button type="button" onclick="editRules()"> RULES </Button>

            <Button type="button" onclick="editContactUs()"> CONTACT US </Button>
        </div>
    
        <script>
            async function FetchSettings(){

                document.getElementById("profile-loader").style.display = "-webkit-inline-box"

                const market_token = getMarketToken()
                const URL = "http://localhost:8000/profile"
                const headers = {"Content-Type" : "application/json; charset=utf-8"}
                const body = JSON.stringify({token: market_token})

                try{

                    const res = await fetch(URL,{
                        method: "POST",
                        mode: "cors",
                        headers: headers,
                        body: body
                    })

                    const res_body = await res.json()
                    const data = await res_body.profile

                    if(!data) throw Error
                    
                    document.getElementById("profile-loader").style.display = "none"
                    document.querySelector("#first_name").insertAdjacentHTML("afterbegin", data.first_name)
                    document.querySelector("#last_name").insertAdjacentHTML("afterbegin", data.last_name)
                    document.getElementById("avatar").src = "data:image/png;base64," + data.avatar
                    document.getElementById("avatar").style.display = "block"

                }catch (error) {
                    console.log(error)
                    location.replace('/')
                }
                
            }

            /* avatar photo edit section */
            function openEditPhotoForm(){
                document.getElementById("popup-form").style.display = "block";
            }
            
            function closeEditPhotoForm() {
                document.getElementById("popup-form").style.display = "none";
            }
            
            const img = document.querySelector("#new-img")
            
            const uploadAvatarButton = document.querySelector("#edit-photo-img")
            
            uploadAvatarButton.addEventListener("change", function(){

                // this is no intially reset back to none then both the previous file will and loader will display
                img.style.display = "none"
                document.getElementById("avatar-loader").style.display = "-webkit-inline-box"

                const file = this.files[0]
                if(file['type'] == "image/heic"){
                    const objectURL = window.URL.createObjectURL(file)

                    new_file = fetch(objectURL)
                        .then((res) => res.blob())
                        .then((blob) =>
                            heic2any({
                                blob,
                                toType: "image/png",
                                multiple: true,
                            })
                        )
                        .then((conversionResult) => {
                            var reader = new FileReader();
                            reader.readAsDataURL(conversionResult[0])
                            reader.onload = function (){
                                const result = reader.result
                                img.src = result
                                document.getElementById("avatar-loader").style.display = "none"
                                img.style.display="revert"
                            }
                        })
                        .catch((e) => {
                            // see error handling section
                            console.log(e)
                        });
                        
                }else if(file){
                    const reader = new FileReader()
                    reader.onload = function(){
                        const result = reader.result
                        img.src = result
                        document.getElementById("avatar-loader").style.display = "none"
                        img.style.display="revert"
                    }
                    reader.readAsDataURL(file)
                }
            })

            async function updateAvatarPhoto(){
                avatar = document.getElementById('new-img')
                cookies = document.cookie.split(';')

                const market_token = getMarketToken()

                const URL = "http://localhost:8000/settings/avatar"
                const headers = {"Content-Type" : "application/json; charset=utf-8"}
                const body = JSON.stringify({
                    token : market_token,
                    avatar : avatar.src
                })

                // make post
                const res = await fetch('http://localhost:8000/settings/avatar', {
                    method: "POST",
                    mode: "cors",
                    headers: headers,
                    body: body
                })

                const data = await req.json()  

                //** STILL IN PROGRESS */
                data ? location.replace("/settings") : location.replace("/")
            }
            
            // view the services settings
            function editServices(){

                `
                    <a href="#" class="list-group-item list-group-item-action" style="display: flex; font-size: medium;">
                        <div style="width: 60%;"> feedback[i][0] + " " + feedback[i][1] <br>
                                    feedback[i][2]
                        </div>
                        <div style="width: 40%;">
                                    
                        </div>
                    </a>
                `


                console.log("Changing Services")
            }
            
            function openEditServices(){
                document.getElementById("service-popup-form").style.display = "block"

                // display loader while fetching the users services
                document.getElementById("service-loader-fetch").style.display = "-webkit-inline-box"

                cookies = document.cookie.split(';')
                market_token = ''

                // retreive market_cookie from cookies
                for(i = 0; i < cookies.length; i++){
                    if(cookies[i].includes('market_token=')){
                        market_token = cookies[i].split('market_token=')[1]
                    }
                }

                // create fetch that calls the backend for all the users services
                fetch('http://localhost:8000/settings/user-services',
                    {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type" : "application/json; charset=utf-8"
                        },
                        body: JSON.stringify(
                            {
                                token: market_token
                            }
                        )
                    }
                )
                .then(result => result.json())
                .then(data => {

                    console.log(data)
                    // stop the loader
                    document.getElementById("service-loader-fetch").style.display = "none"
                    // insert the service data inside the service list

                })
                .catch(err => {
                    location.replace("/")
                })
            }
            
            function closeEditServices(){
                document.getElementById("service-popup-form").style.display = "none"
            }

            // view the history settings
            function editHistory(){
                console.log("Changing History")
            }

            // view activity settings 
            function editActivity(){
                console.log("Changing Activity")
            }

            // view account settings
            function editAccount(){
                console.log("Changing Account")
            }

            // view rules settings
            function editRules(){
                console.log("Viewing Rules")
            }
            
            // send a contact us 
            function editContactUs(){
                console.log("Sending a Contact Us")
            }
     
            function editAccountPopup(){
                document.getElementById("settings-popup").style.display = "block"

                const first_name = document.querySelector("#first_name").innerHTML
                const last_name = document.querySelector("#last_name").innerHTML

                document.getElementById("popup-view").innerHTML = `
                <form class="form-container" action={handleAccountChange()}>
                    <h2>Edit Account</h2>

                    <h4>Edit Avatar</h4>
                    
                    <div class="uploaded-image" id="uploaded-image">
                        <div class="loader" id="avatar-loader"></div>
                        <img src="" alt="" id="new-img" class="new-img">
                    </div>
                    Select Image: 
                    
                    <input type="file" id="edit-photo-img" name="img" accept="image/*" required>
                    
                    <h4>Edit Name </h4>
                    
                    First Name:

                    <input type="text" id="edited-first-name" value="${first_name}" required>

                    Last Name:

                    <input type="text" id="edited-last-name" value="${last_name}" required>

                    <Button type="submit" id="name-edit-btn" class="name-edit-btn"> Make Change </Button>
                </form>`
            }

            // make changes to users name
            async function handleAccountChange(){

                const first_name = document.getElementById("edited-first-name").value
                const last_name = document.getElementById("edited-last-name").value

                const market_token = getMarketToken()

                const URL = "http://localhost:8000/settings/name"
                const body = JSON.stringify({ token: market_token, first_name : first_name, last_name : last_name })
                const headers = {"Content-Type" : "application/json; charset=utf-8"}

                try {
                    const req = await fetch(URL, {
                        method: "POST",
                        mode: "cors",
                        headers: headers,
                        body: body
                    })

                    const res = await req.json()

                    if(res) {
                        location.replace("/settings") 
                        return 
                    }

                    throw error

                } catch(error) {
                    location.replace("/")
                }
            }

            function closePopup(){
                document.getElementById("settings-popup").style.display = "none"
            }

            // function used for going back to dashboard
            function goBack(){
                location.replace("/dashboard")
            }

            // *  HELPERS */
            const getMarketToken = () => {
                cookies = document.cookie.split(';')
                market_token = null

                // retreive market_cookie from cookies
                for(i = 0; i < cookies.length; i++){
                    if(cookies[i].includes('market_token=')){
                        return market_token = cookies[i].split('market_token=')[1]
                    }
                }
                return market_token
            }
        </script>
    </body>
</html>